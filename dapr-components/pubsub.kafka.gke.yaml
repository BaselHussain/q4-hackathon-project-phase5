# Dapr Pub/Sub Component: Self-hosted Redpanda (Kafka-compatible)
# For Google Kubernetes Engine (GKE) deployment
# Note: Google Pub/Sub is not Kafka-compatible, so we deploy Redpanda on GKE
apiVersion: dapr.io/v1alpha1
kind: Component
metadata:
  name: pubsub
spec:
  type: pubsub.kafka
  version: v1
  metadata:
    # Redpanda broker running in GKE cluster
    # Deployed via Helm: helm install redpanda redpanda/redpanda
    - name: brokers
      value: "redpanda.redpanda.svc.cluster.local:9093"

    # Authentication
    - name: authType
      value: "password"

    # Redpanda uses SCRAM-SHA-256 SASL mechanism
    - name: saslMechanism
      value: "SCRAM-SHA-256"

    # Redpanda credentials from Kubernetes secret
    - name: saslUsername
      secretKeyRef:
        name: redpanda-creds
        key: sasl-username

    - name: saslPassword
      secretKeyRef:
        name: redpanda-creds
        key: sasl-password

    # Consumer group (uses Dapr app-id)
    - name: consumerGroup
      value: "{APP_ID}"

    # Start from oldest message on first connect
    - name: initialOffset
      value: "oldest"

    # Maximum message size (1MB)
    - name: maxMessageBytes
      value: "1048576"

    # Retry interval on consume errors
    - name: consumeRetryInterval
      value: "1000ms"

    # Kafka protocol version
    - name: version
      value: "3.0.0"

    # TLS enabled for in-cluster Redpanda (production)
    - name: disableTls
      value: "false"
